name: Crawl4AI - Sitemap Crawler

env:
  TZ: Asia/Manila
  PRODUCTION_BRANCH: master
  STAGING_BRANCH: staging
  EMAIL: "github-actions[bot]@users.noreply.github.com"
  USER: "github-actions[bot]"
  SITEMAP_FILE: "sitemaps.txt"
  CLEAN_DATA: "true"
  MAX_URLS: "300" # limit

on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  crawl-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout staging (trigger branch)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      # 2️⃣ Confirm branch and timezone
      - name: Time and branch check
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "The time is: $(date)"
          timedatectl

      # 3️⃣ Set up Python (for crawler)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 4️⃣ Install crawler dependencies

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --pre crawl4ai python-dotenv requests
          crawl4ai-setup
          crawl4ai-doctor || true
          python -m playwright install --with-deps chromium

      # 5️⃣ Run the crawler
      - name: Run sitemap crawler
        run: |
          echo "Running Crawl4AI sitemap crawler..."
          mkdir -p data
          python crawler/crawl.py

      # 6️⃣ Diagnostics: show output
      - name: Check output data
        run: |
          echo "=== Generated Markdown files ==="
          ls -lah data || true
          echo "=== Sample preview ==="
          head -n 15 $(ls data/*.md | head -n 1) || true

      # 7️⃣ Deploy to production branch
      - name: Deploy generated content to production branch
        run: |
          git config --local user.email "$EMAIL"
          git config --local user.name "$USER"

          echo "Preparing production deployment..."
          git fetch origin

          if git rev-parse --verify origin/$PRODUCTION_BRANCH >/dev/null 2>&1; then
            echo "Remote production branch exists"
            git branch -D $PRODUCTION_BRANCH 2>/dev/null || true
            git checkout -b $PRODUCTION_BRANCH
          else
            echo "Remote production branch doesn't exist, creating new one..."
            git checkout -b $PRODUCTION_BRANCH
          fi

          if [ -d ".github" ]; then
            rm -rf .github
          fi

          cat > README.md << EOF
          # Crawl4AI Data v2 (Production)

          This branch contains Markdown data crawled from:
          - Listed in sitemaps.txt

          **Last Crawl:** $(date -Iseconds)
          EOF

          git add -A data README.md
          git status

          if git diff --cached --quiet; then
            echo "ℹ️ No changes to deploy"
          else
            COMMIT_MSG="crawl: sitemap content [$(date -Iseconds)]"
            git commit -m "$COMMIT_MSG"
            git push --force-with-lease origin $PRODUCTION_BRANCH
            echo "✅ Successfully deployed crawled data to $PRODUCTION_BRANCH"
          fi
